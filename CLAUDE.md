<!-- Ctrl + K V -->

# CLAUDE.md（CLAUDE CODE や Codexなど AIエージェント向け）

 最初に ProjectPolicy.md を読んで、プロジェクト全体の運用ルールを把握し、全体として方針はこられに従う。
 （内容に矛盾があるようなら、設計開発者に報告し、随時修正する。）
 AIとのチャットのやり取りは日本語を使用する。

## AIの基本ルール
- AIは git コマンドを基本的には実行しない。(必要なら確認を取ってから実行する)
  git mv など、どうしてもAIが実行した方が効率が良い場合は、確認しながら実行する。

- AIは作業に時間が見込まれる場合（1分以上）、先に時間がかかることをメッセージとして出力して、最終的に BurnToast で作業完了を通知する。
  その際、Toastの実行承認を不要にするため AIへの依頼はターミナル実行から行う。（要 Node.js と @openai/codex）

  例）
    .\run-codex.ps1 -Prompt "index.htmlのファイルサイズを教えて"

## ソースコード(共通)
- 圧縮（minify）、を前提としたコードを作成すること。
- 圧縮後も、コードが変わる可能性もゼロではないので、AIにチェックさせる。

  > wwwを minify した dist フォルダ 内のファイルを静的チェック（HTML/CSS/JS の構文チェック（lint）レベル）して。使うツールはお任せします。
  > wwwを minify した dist フォルダは、内容としては同じはずです。ブラウザで見るレベルで同じになっているか、精査してください。
  > dist と www を比較するとき、ファイルを改変しないのなら、こちらにコマンド実行の可否を確認する必要は無いです。

- 将来的に 難読化 も対応するので、それを前提としたコードを作成すること。
- 将来的に 最終的に 難読化 → 圧縮、の順にBuildすること。

- フォルダ内にファイルが多くなってきたときは、適切なフォルダ分け、階層分けをすること。

## ソースコード(*.html)
- 画面遷移の仕様に従って（ preconnect / preload / modulepreload / prefetch ） を入れる。

- index.html 以外の画面は noindex を入れて、検索サイトに「そのページを検索結果に出さないで」と伝える

- 英語と日本語の翻訳に関しては、以下のようにする。翻訳箇所に英語と日本語を用意する。
- ただし、操作画面の Back / Done は翻訳不要です。

  例）
    <span class="lang" data-lang="en">Manual</span>
    <span class="lang" data-lang="ja">使い方</span>

- <html translate="no"> を付けて翻訳不要とする。
  過去に lang="en" などとする対応もあったが、lang を付けると自動翻訳が動作するようで、lang は付けない方針とする。

- HTML内の aria-label 属性は英語表記を使用する。

- HTMLではスクロールバーを強制的に非表示にする場合は、コメントで非表示にする理由を書いて後から見ても理解できるようにする。

## ソースコード(*.js)
- 各ファイルの先頭に、ファイルの役割・クラスの役割など、そのファイル単位の役割や仕様をコメントで記載する。

- ES module で統一する。(圧縮時の処理安定も兼ねるための対策)

- index.html 以外の画面をブックマーク等で直接開いた場合は、index.html へ転送する処理。（フォールバック）

- ブラウザ内の操作の画面遷移は、同一タブ内の画面遷移を前提とし、Back/Done は history.back() で戻る。（履歴が無い場合は index.html へ戻す）
  ただし、フッターの外部WEBサイトへのリンクは別タブのリンクとする。
  また、外部ファイル（PDFなど）への保存操作時も別タブ表示で問題ないとする。

- JSの画面単位で設定値を編集するとき "< Back" "Done" ボタンがある場合は、"Done" ボタンクリック時に編集結果を保存する。（ "< Back" ボタンでは何もしない。）
  その際データを保持するのに sessionStrage が有効なら使用してもよい。
  （このようにする理由はブラウザのバックボタンで画面が戻ったときに、編集が保存されないようにするため。）

- 外部からもってきらライブラリは lib フォルダで管理する。
- 外部からもってきらライブラリの内、ライセンスファイルの同梱が必要な場合 assets/licenses フォルダ内に入れる。

## ソースコード(*.css)
- 各種属性にはコメントを追加して、後から手動で編集しやすくしておく。

- 縦長の画面は svh/dvh を html / body に適用することを検討する。（勝手にスクロールす現象が抑えれます。）
- 横長の画面で editScore の画面で、スマホ横持ち時の対応として、min-height を指定する。
  例）
    min-height: 100svh;
    min-height: 100dvh;

## 設定パラメータ
- アプリ内で設定する設定パラメータには、基本的に上限下限を設けること。
- 上限下限値は、データ入力の時だけでなく、保存データからLoadするときにもチェックすること。
- 上限下限の範囲から外れたデータが来たときは不正なデータとして処理を停止する。Load時の不正値発見ならLoadしない。
  例）PDFの添付ファイル(*.json)を読むときは、読込を中止する。
- パラメータごとの入力を許容する範囲は以下の通り

  |項目           | 画面                         | 設定値 または 下限値と上限値
  |-|-|-
  |テンポ         | index、configBeat、editScore | 下限=30 上限=240
  |クリック拍数    | configBeat                  | 下限=1 上限=8
  |カウントイン    | configBeat                  | 下限=0 上限=10
  |ボリューム(UI)  | configBeat                  | 下限=0 上限=10
  |拍子           | configScore                  | "2/4" "3/4" "4/4"
  |小節数         | configScore                  | 下限=1 上限=12
  |1段当たり表示小節数 | editScore                | 下限=1 上限=4
  |小節数         | editScore（小節 削除時）      | 下限=1 （小節数1のとき、削除は不可）
  |小節数         | editScore（小節 複写時）      | 上限=50 (小節数50まで複写可能)
  |コード進行      | configScore、editMeasure    |下限=0 上限=10


### コメント
- コメントは日本語で書く
- HTMLで、`<!--Spec -->`で書かれたコメントは仕様なので、コード改変時には原則削除しない。どうしても変更が必要な場合は、確認する。
- JavaScriptで、`//##Spec` や `/*##Spec */`で書かれたコメントは仕様なので、コード改変時には原則削除しない。どうしても変更が必要な場合は、確認する。
- 関数を作成したら、関数ヘッダコメントを作成すること。
- 処理にも適宜コメントを挿入すること。


### 改変の範囲に関して
- ワークスペース内のソースコードを修正すること。
- ワークスペース外のソースコードや設定ファイルをどうしても修正する必要があれば、確認してOKなら変更すること。

### 内部・外部保存に関して
- ファイルやIndexeDBはLocalStrageなど、保存仕様を変更する場合は、確認してから変更する。
- ファイルやIndexeDBはLocalStrageなど、保存仕様を拡張する場合は、以前の仕様を変更して処理できなくなる場合は、確認してから変更すること。

- PDF の添付ファイルについては、Acrobat Reader DCで確認できる。右のクリップアイコンから確認。（添付ファイルの確認は開発用）

- PDF の添付ファイル(*.json)が、保存データとしては本体。scoreSerialization.js の Spec コメントに、バージョンアップと保存形式の関係について記載している。

## リリース前の静的チェックに関して
- AIは コマンド `npm run build` は 実行しない。(開発者が実行する)

## デバッグに関して
- 難解な不具合原因を追う必要があるとき（不具合は起きるけど原因が分からないの不具合を調べるとき）は、動作ステップの分かるログ出力コードを細かく挿入する。
- 挿入した動作ステップ状況（どこまで動作して、どういった変数になったか）の情報をAIと人がやり取りすることで原因を究明していくこと。

