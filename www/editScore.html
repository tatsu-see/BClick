<!--Spec
  editScore.html では、楽譜データを１小節ずつ編集する画面を表示する。
  index.html からは、楽譜データのコピーを受け取ること。
  <Back を選択したら編集を無かったことにするので、保存しないで index.htmlに戻る。
  Done を選択したら、その時に初めて編集結果をLocalStrageに保存して、楽譜データを index.html に返し編集を完了する。
-->
<!doctype html>
<html>
<head>

  <meta charset="utf-8">
  <meta name="robots" content="noindex">
  <meta name="description" content="">
  <meta name="keywords" content="">

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#111111">
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="B.Click">
  <meta name="mobile-web-app-capable" content="yes">

  <title>B.Click - Score Playback / スコア再生</title>
  <link rel="icon" type="image/png" sizes="16x16"   href="/assets/icons/BClick-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32"   href="/assets/icons/BClick-32x32.png">
  <link rel="icon" type="image/png" sizes="64x64"   href="/assets/icons/BClick-64x64.png">
  <link rel="icon" type="image/png" sizes="128x128" href="/assets/icons/BClick-128x128.png">
  <link rel="icon" type="image/png" sizes="256x256" href="/assets/icons/BClick-256x256.png">

  <link rel="stylesheet" href="/assets/lib/Language.css">
  <link rel="stylesheet" href="/assets/css/app.css">
  <link rel="stylesheet" href="/assets/css/tempoDial.css">
  <link rel="stylesheet" href="/assets/css/click.css">
  <link rel="stylesheet" href="/assets/css/editScore.css">
  <link rel="stylesheet" href="/assets/lib/ShowMessageBox.css">
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet">

  <!-- Resource hints -->
  <link rel="prefetch" href="/editMeasure.html" as="document">
  <link rel="prefetch" href="/assets/css/editMeasure.css" as="style">
  <link rel="prefetch" href="/assets/js/pages/editMeasure.js" as="script">

  <link rel="modulepreload" href="/assets/js/utils/navigationGuard.js">
  <link rel="modulepreload" href="/assets/lib/ShowMessageBox.js">

  <script type="module" src="/assets/lib/Language.js"></script>

  <script src="/assets/lib/pdf-lib.min.js"></script>
  <script type="module" src="/assets/js/pages/click.js"></script>
  <script src="/assets/lib/alphaTab/alphaTab.min.js"></script>
  <script type="module" src="/assets/js/pages/editScore.js"></script>
  <script type="module" src="/assets/js/actions/saveScoreButton.js"></script>
  <script type="module" src="/assets/js/actions/loadScoreButton.js"></script>
</head>

<!--Spec 作成した楽譜を編集やクリック音の再生をする画面
・Backは、設定を保存せずに画面遷移する。Doneは、設定を保存して画面遷移する。
・１小節ずつ編集する機能もある。
・クリック音の再生中に、BPMを変更することでクリック音の速度を変更可能。
-->

<body>
  <header>
    <button type="button" id="backShowScore" class="okConfig" aria-label="Back">
      <span class="navChevron" aria-hidden="true">&lsaquo;</span>
      <span class="navLabel">Back</span>
    </button>
    <div id="title" class="titleStack">
      <span class="titleMain"><img src="/assets/icons/B.png" alt="B" class="titleIcon">.Click</span>
      <span class="titleSubtitle">— play daily, play better —</span>
    </div>
    <button type="button" id="saveShowScore" class="okConfig" aria-label="Save and back">Done</button>
    <!-- editScore.html は必ず編集操作になるので、閉じるボタンによる編集無効のボタンは不要
    <button id="closePage" type="button" aria-label="閉じる">×</button>
    -->
  </header>
  <main class="pageFrame">

    <!-- ここに テンポ（30～240）のBPMダイアルを用意する
    ・クリック音の再生中にテンポを変更すると、クリック音の再生スピードが、変更したテンポになる。
    -->
    <div class="preferenceTitle tempoTitle">
      <div class="tempoTitleText">
        <span class="material-symbols-rounded" aria-hidden="true">tune</span>
        <span class="lang" data-lang="en">Settings</span>
        <span class="lang" data-lang="ja">調節</span>
      </div>

      <!--Spec editScore.html の トグルスイッチの特殊仕様
      ・ここに <div id="beatPreference"> の表示をON/OFF切り替えられるスイッチを用意する。初期値はOFFで表示しない。
      ・スイッチの見た目は、index.html の <input type="checkbox" id="scoreToggle"> と同じ見た目。
      ・文字は OFF と ON を表示して。ON場合は少し濃い緑色を使う。
      ・トグルスイッチのON/OFF情報は楽譜としては保存されないが、アプリの動作状態としては記憶され再現される。
        そのため、editMeasure画面から戻ってきたときや、editScore画面から"< Back"でindex画面へ移動し、index画面から
        「演奏」（編集）ボタンで editScore画面に戻ってきたときは、再現される。
      ・トグルスイッチのON/OFF情報は、configBeatの初期化ボタンや、index画面の（新規）「作成」ボタンによって初期化（=OFF）される。
      ・ON/OFFの状態の保持は LocalStrage に行う。
      -->
      <div class="preferenceValue preferenceValueCentered tempoDialToggleControl">
        <label class="scoreToggle">
          <input type="checkbox" id="tempoDialToggle" aria-label="Toggle tempo dial">
        </label>
      </div>

    </div>

    <div id="beatPreference" class="tempoControl tempoControlStack">

      <!-- テンポを表示 -->
      <div class="preferenceTitle">
        <span class="material-symbols-rounded" aria-hidden="true">speed</span>
        <span class="lang" data-lang="en">Tempo (30–240)</span>
        <span class="lang" data-lang="ja">テンポ（30～240）</span>
      </div>

      <div class="tempoValueGroup tempoValueTop">
        <div class="tempoStepSwitch">
          <span class="tempoInputNote">♪=</span>
          <input type="number" id="tempoInput" class="tempoInputLarge" min="30" max="240" value="60" inputmode="numeric" readonly>

        </div>
      </div>

      <div class="tempoDialRow" id="tempoDialRow" role="group" aria-label="Tempo change mode">
        <button type="button" id="tempoStepCoarse" class="tempoStepButton" data-step="10" aria-pressed="false">±10</button>
        <button type="button"
          class="tempoDial"
          id="tempoDial"
          data-step="10"
          data-degrees-per-step="36"
          aria-label="Change tempo by 10">
          <span class="tempoDialSide tempoDialMinus" aria-hidden="true">-</span>
          <span class="tempoDialIndicator" aria-hidden="true"></span>
          <span class="tempoDialLabel">10</span>
          <span class="tempoDialSide tempoDialPlus" aria-hidden="true">+</span>
        </button>
        <button type="button" id="tempoStepFine" class="tempoStepButton isActive" data-step="1" aria-pressed="true">±1</button>
      </div>

      <div class="preferenceTitle">
        <span class="lang" data-lang="en">Bars per row (1–4)</span>
        <span class="lang" data-lang="ja">一段当たりの小節数（1〜4）</span>
      </div>
      <!--Spec 1段当たりの小節通
      ・スライドバーを配置して1段当たりの小節数を設定する。設定範囲は（1～4）。初期値は2。
      -->

      <div class="preferenceValue preferenceValueCentered barsPerRowValue">
        <input type="range" id="barsPerRowRange" min="1" max="4" step="1" value="2" aria-label="Bars per row">
        <output id="barsPerRowValue" for="barsPerRowRange">2</output>
      </div>

    </div>

    <!--Spec クリック再生エリア-開始 -->
    <div class="preferenceTitle">
      <span class="material-symbols-rounded" aria-hidden="true">play_circle</span>
      <span class="lang" data-lang="en">Play</span>
      <span class="lang" data-lang="ja">再生</span>
    </div>

    <div id="playClicking">
      <button id="startClick" type="button" class="chipButton" aria-label="Play">
        <span class="material-symbols-rounded" aria-hidden="true">play_arrow</span>
        <span class="lang" data-lang="en">Play</span>
        <span class="lang" data-lang="ja">再生</span>
      </button>
      <button id="stopClickart" type="button" class="chipButton" aria-label="Pause">
        <span class="material-symbols-rounded" aria-hidden="true">pause</span>
        <span class="lang" data-lang="en">Pause</span>
        <span class="lang" data-lang="ja">停止</span>
      </button>
      <button id="resetClickart" type="button" class="chipButton" aria-label="Reset">
        <span class="material-symbols-rounded" aria-hidden="true">restart_alt</span>
        <span class="lang" data-lang="en">Reset</span>
        <span class="lang" data-lang="ja">リセット</span>
      </button>
      <button id="showCodeDiagram" type="button" class="makeScoreButton makeScoreButtonCompact navButton">
        <span class="material-symbols-rounded" aria-hidden="true">back_hand</span>
        <span class="lang" data-lang="en">Chords</span>
        <span class="lang" data-lang="ja">コード</span>
      </button>
    </div>

    <div id="clickPane">
      <div id="showClick">
        <!-- (ここにクリックが表示されます) -->
      </div>
    </div>
    <!--Spec クリック再生エリア-終了 -->

    <div id="scorePane">
      <div id="countdownOverlay" aria-hidden="true" hidden>
        <div id="countdownText" aria-live="polite"></div>
      </div>

      <div id="scoreArea">
        <!--Spec  (ここにリズム譜が表示されます)
        ・小節内の音符の表示については、configScore.html の "Spec 楽譜の１小節内のリズムパターン" と同じルールです。
          特に16分音符の描画については組み合わせと旗の結合ルールがあるので、これと同じにします。
          ルールを同じにするといっても、RhythmTokenBuilder.js を使うわけではなく、仕様が同じもので別に実装します。
          alphaTex は音符に対して { d } で付加して情報を付加し、複数の情報を付加する場合は { slashed d } と複数並べる。

        ・リズム譜では、小節番号をクリックやタップをしたら、その小節の編集画面に移動します。

        ・クリックやタップできる小節番号<div>は、svg内のtextタグとして存在している小節番号と重なるように作成する。
          ただし、クリックやタップできるとユーザに知らせたいので、縦方向はsvg-textの2倍、横方向は2.5倍の大きさにする。
          枠線は緑で太くして、小節番号は白の太字、背景色は緑とする。

        ・クリック音の再生時には、クリック音が４拍なら４拍ごとに小節番号を表示するようにスクロールする。
          クリック再生時、１巡して次に演奏する小節番号は色が変化するが、その時の小節番号は緑の太字、背景色は白色とする。
          （可能性として、１巡して次に演奏する小節番号は非表示でもいいのかもしれない。コードを確認するため。）
        -->
        <div id="score" aria-label="Two-measure score"></div>
      </div>
    </div>

    <div class="preferenceTitle">
      <span class="material-symbols-rounded" aria-hidden="true">folder</span>
      <span class="lang" data-lang="en">File</span>
      <span class="lang" data-lang="ja">ファイル</span>
    </div>

    <!--Spec スコアの操作ボタン
      以下のボタンは、configBeat.html画面やconfigScore.html画面で設定した情報から楽譜を新規生成したり、保存したりする機能のボタンである。
      ボタンは1行に横並びで表示し、ボタンを等しい幅で配置する。
      以下の楽譜編集ボタンや、楽譜ファイル(*.json)の操作ボタンは、app.js に全部実装するのではなくて、適宜モジュールに分割して実装する。

      ・Saveボタン
        現在編集中の楽譜情報をローカルストレージに保存する。具体的には楽譜データをJSONファイルとしてダウンロードする。
        （本当はファイル選択で保存先を指定できると良いが、iOS Safari は仕様上難しいためこの方法を採用している。）

      ・Loadボタン
        Saveによって保存した楽譜JSONファイルをファイル選択して読み、アプリの設定画面で編集可能な状態にする。

      ・Merge トグルスイッチ
        ONのときに、Load操作を若干変更する。選択したファイルの楽譜の小節部分を、今編集中の楽譜の後ろに小節を結合する。
        ただし、同じ拍子でないと結合はできない。
    -->
    <div class="preferenceExec isRow4">
      <div></div>
      <button id="saveScore" type="button" class="okConfig makeScoreButton navButton">
        <span class="material-symbols-rounded" aria-hidden="true">save</span>
        <span class="lang" data-lang="en">Save</span>
        <span class="lang" data-lang="ja">保存</span>
      </button>

      <button id="loadScore" type="button" class="okConfig makeScoreButton navButton">
        <span class="material-symbols-rounded" aria-hidden="true">folder_open</span>
        <span class="lang" data-lang="en">Load</span>
        <span class="lang" data-lang="ja">読込</span>
      </button>

      <div class="mergeToggle">
        <label class="scoreToggle">
          <input type="checkbox" id="mergeToggle" aria-label="Toggle merge mode">
          <script>
            (function() {
              try {
                const saved = localStorage.getItem("bclick.score.merge");
                if (saved === null) return;
                const parsed = JSON.parse(saved);
                const toggle = document.getElementById("mergeToggle");
                if (toggle) {
                  toggle.checked = parsed === true;
                }
              } catch (e) {
                ;
              }
            })();
          </script>
        </label>
      </div>
    </div>
    <input type="file" id="loadScoreFile" accept="application/pdf,application/json" hidden>

  </main>

  <!--Spec メッセージ表示用の文字列 -->
  <div id="loadScoreMessage" class="messageBox">
    <span class="lang" data-lang="en">Loaded.</span>
    <span class="lang" data-lang="ja">読み込みました。</span>
  </div>

  <div id="barCopyMessage" class="messageBox">
    <span class="lang" data-lang="en">Bar copied.</span>
    <span class="lang" data-lang="ja">コピーしました。</span>
  </div>

  <div id="barDuplicateMessage" class="messageBox">
    <span class="lang" data-lang="en">Bar duplicated.</span>
    <span class="lang" data-lang="ja">複製しました。</span>
  </div>

  <div id="barPasteMessage" class="messageBox">
    <span class="lang" data-lang="en">Bar pasted.</span>
    <span class="lang" data-lang="ja">貼り付けました。</span>
  </div>

  <footer>
    <small>&copy; 2025 tatsu. All rights reserved.</small>
  </footer>

</body>
</html>



